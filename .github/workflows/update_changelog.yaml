name: Update CHANGELOG.md

on:
  push:
    tags:
      - 'v*'

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get tag details and commits
        id: tag_details
        run: |
          echo "TAG_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          PREV_TAG=$(git describe --tags --abbrev=0 ${GITHUB_REF}^)
          COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:'%H: %s (%an <%ae>)')
          echo "COMMITS=${COMMITS}" >> $GITHUB_ENV
      - name: Update CHANGELOG.md
        run: |
          git checkout gh-pages

          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/)," >> CHANGELOG.md
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          RELEASE_DATE=$(date +'%Y-%m-%d')
          TEMP_FILE=$(mktemp)
          echo "## [${TAG_NAME}] - ${RELEASE_DATE}" > $TEMP_FILE
          echo "" >> $TEMP_FILE
          echo "${COMMITS}" | while IFS= read -r line; do
            if [[ $line =~ feat.* ]]; then
              echo "ðŸš€ Features" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ fix.* ]]; then
              echo "ðŸž Bug fixes" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ perf.* ]]; then
              echo "ðŸ’ª Performance improvements" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ docs.* ]]; then
              echo "ðŸ“ƒ Documentation" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ style.* ]]; then
              echo "ðŸ•¶ï¸ Styles" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ refactor.* ]]; then
              echo "âš’ï¸ Refactor" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ test.* ]]; then
              echo "ðŸ§ª Tests" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            elif [[ $line =~ chore.* ]]; then
              echo "ðŸ’» Chores" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            else
              echo "ðŸ”” Others" >> $TEMP_FILE
              echo "- ${line}" >> $TEMP_FILE
            fi
          done

          echo "" >> $TEMP_FILE
          cat CHANGELOG.md >> $TEMP_FILE
          mv $TEMP_FILE CHANGELOG.md
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md for ${TAG_NAME}" || echo "No changes to commit"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}