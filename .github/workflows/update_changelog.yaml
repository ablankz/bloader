name: Update CHANGELOG.md

on:
  push:
    tags:
      - 'v*'

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get tag details and commits
        id: tag_details
        run: |
          echo "TAG_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          PREV_TAG=$(git describe --tags --abbrev=0 ${GITHUB_REF}^)
          COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:'%H: %s (%an <%ae>)') > commits.txt
      - name: Update CHANGELOG.md
        run: |
          git checkout gh-pages

          TEMP_FILE=$(mktemp)

          echo "# Changelog" > $TEMP_FILE
          echo "" >> $TEMP_FILE
          echo "All notable changes to this project will be documented in this file." >> $TEMP_FILE
          echo "" >> $TEMP_FILE
          echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/)," >> $TEMP_FILE
          echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)." >> $TEMP_FILE
          echo "" >> $TEMP_FILE

          cat $TEMP_FILE

          if [ ! -f CHANGELOG.md ]; then
            CHANGELOG_BODY=""
          else
            TITLE_LINE_COUNT=3 # Number of lines in the title section
            CHANGELOG_BODY=$(tail -n +"$((TITLE_LINE_COUNT + 1))" CHANGELOG.md)
          fi

          echo "$CHANGELOG_BODY"

          cat commits.txt

          RELEASE_DATE=$(date +'%Y-%m-%d')
          BODY_FILE=$(mktemp)
          echo "## [${TAG_NAME}] - ${RELEASE_DATE}" > $BODY_FILE
          echo "" >> $BODY_FILE
          cat commits.txt | while IFS= read -r line; do
            if [[ $line =~ feat.* ]]; then
              echo "🚀 Features" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ fix.* ]]; then
              echo "🐞 Bug fixes" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ perf.* ]]; then
              echo "💪 Performance improvements" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ docs.* ]]; then
              echo "📃 Documentation" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ style.* ]]; then
              echo "🕶️ Styles" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ refactor.* ]]; then
              echo "⚒️ Refactor" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ test.* ]]; then
              echo "🧪 Tests" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            elif [[ $line =~ chore.* ]]; then
              echo "💻 Chores" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            else
              echo "🔔 Others" >> $BODY_FILE
              echo "✔️ ${line}" >> $BODY_FILE
            fi
          done
          echo ""
          echo "$CHANGELOG_BODY" >> $BODY_FILE
          cat $TEMP_FILE $BODY_FILE > CHANGELOG.md
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md for ${TAG_NAME}" || echo "No changes to commit"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}